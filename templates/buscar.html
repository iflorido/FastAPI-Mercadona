<script src="https://unpkg.com/@ericblade/quagga2@1.8.4/dist/quagga.min.js"></script>

<style>
    /* El contenedor de la cámara */
    #interactive.viewport {
        position: relative;
        width: 100%;
        height: auto;
        overflow: hidden;
        background: #000;
        border-radius: 8px;
    }
    
    /* El video debe ocupar todo el espacio */
    #interactive.viewport > video {
        max-width: 100%;
        width: 100%;
        border-radius: 8px;
    }

    /* El canvas donde Quagga dibuja las líneas verdes de detección */
    #interactive.viewport > canvas.drawingBuffer {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        border-radius: 8px;
    }
</style>

<div class="d-flex flex-column flex-md-row gap-2 align-items-center w-100">
    <form action="{{ url_for('search_products') }}" method="get" class="flex-grow-1 w-100" id="searchForm">
        <div class="input-group">
            <span class="input-group-text bg-white text-muted border-end-0"><i class="bi bi-search"></i></span>
            <input type="search" id="search-input" name="query" class="form-control border-start-0 ps-0 border-end-0" placeholder="Buscar producto..." required>
            <button class="btn btn-outline-secondary border-start-0 border-end-0" type="button" onclick="openScanner()"><i class="bi bi-upc-scan"></i></button>
            <button class="btn btn-success" type="submit">Buscar</button>
        </div>
    </form>
    {% if request.url.path != '/' %}
    <a href="/" class="btn btn-outline-secondary text-nowrap"><i class="bi bi-house-door-fill"></i> Inicio</a>
    {% endif %}
</div>

<div class="modal fade" id="scannerModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">Escanear Producto</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" onclick="stopScanner()"></button>
      </div>
      <div class="modal-body p-0 bg-dark position-relative">
        
        <div id="interactive" class="viewport"></div>

        <div class="position-absolute bottom-0 start-0 w-100 p-2 text-white bg-dark bg-opacity-75 text-center">
            <small>Si ves líneas verdes, ¡estamos detectando!</small>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
    function openScanner() {
        const myModal = new bootstrap.Modal(document.getElementById('scannerModal'));
        myModal.show();
        
        const modalElement = document.getElementById('scannerModal');
        modalElement.addEventListener('shown.bs.modal', startQuagga);
        modalElement.addEventListener('hidden.bs.modal', stopScanner);
    }

    function startQuagga() {
        Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: document.querySelector('#interactive'),
                constraints: {
                    facingMode: "environment", // Cámara trasera
                    // En Quagga no necesitamos ser tan estrictos con resoluciones
                    // dejamos que negocie la mejor automáticamente
                }
            },
            // Configuramos solo lectores de códigos de barras (EAN)
            decoder: {
                readers: [
                    "ean_reader", // EAN-13 (El estándar de Mercadona)
                    "ean_8_reader" // Versión corta
                ]
            },
            // Configuramos la localización (las líneas verdes)
            locate: true 
        }, function(err) {
            if (err) {
                console.log(err);
                alert("Error al iniciar cámara: " + err);
                return;
            }
            console.log("Quagga iniciado");
            Quagga.start();
        });

        // Evento: Cuando detecta una posible línea (dibuja caja verde)
        Quagga.onProcessed(function(result) {
            var drawingCtx = Quagga.canvas.ctx.overlay,
                drawingCanvas = Quagga.canvas.dom.overlay;

            if (result) {
                // Limpiamos el canvas frame a frame
                if (result.boxes) {
                    drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.getAttribute("width")), parseInt(drawingCanvas.getAttribute("height")));
                    result.boxes.filter(function (box) {
                        return box !== result.box;
                    }).forEach(function (box) {
                        Quagga.ImageDebug.drawPath(box, {x: 0, y: 1}, drawingCtx, {color: "green", lineWidth: 2});
                    });
                }

                if (result.box) {
                    Quagga.ImageDebug.drawPath(result.box, {x: 0, y: 1}, drawingCtx, {color: "#00F", lineWidth: 2});
                }

                if (result.codeResult && result.codeResult.code) {
                    Quagga.ImageDebug.drawPath(result.line, {x: 'x', y: 'y'}, drawingCtx, {color: 'red', lineWidth: 3});
                }
            }
        });

        // Evento: Cuando CONFIRMA la lectura del código
        Quagga.onDetected(function(result) {
            var code = result.codeResult.code;
            console.log("Código detectado:", code);
            
            // Verificación simple: Mercadona usa EAN-13, deben ser números
            if(code && code.length >= 8) {
                stopScanner();
                
                // Cerrar modal
                const modalEl = document.getElementById('scannerModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();

                // Rellenar y enviar
                document.getElementById('search-input').value = code;
                document.getElementById('searchForm').submit();
            }
        });
    }

    function stopScanner() {
        Quagga.stop();
        // Limpiar el canvas manualmente para que no se quede la última imagen congelada
        const container = document.querySelector('#interactive');
        if(container) container.innerHTML = ""; 
    }
</script>