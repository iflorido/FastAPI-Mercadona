<script src="https://unpkg.com/@ericblade/quagga2@1.8.4/dist/quagga.min.js"></script>

<style>
    /* Contenedor principal de la cámara */
    #interactive.viewport {
        position: relative;
        width: 100%;
        height: auto;
        overflow: hidden;
        background: #000;
        border-radius: 8px;
    }
    
    #interactive.viewport > video {
        max-width: 100%;
        width: 100%;
        border-radius: 8px;
        opacity: 0.8; /* Un poco oscuro para resaltar el cuadro de escaneo */
    }

    /* Canvas donde se pintan las líneas verdes (debug) */
    #interactive.viewport > canvas.drawingBuffer {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
    }

    /* EL CUADRO ROJO VISUAL (Guía para el usuario) */
    /* Coincide con el área de lectura configurada en JS (80% ancho, 30% alto) */
    .scanner-box {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 80%;
        height: 150px;
        border: 2px solid rgba(255, 0, 0, 0.7);
        box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5); /* Oscurece el resto */
        border-radius: 10px;
        z-index: 10;
    }
    
    .scanner-line {
        position: absolute;
        width: 100%;
        height: 2px;
        background: red;
        top: 50%;
        animation: scanline 2s infinite;
        box-shadow: 0 0 4px red;
    }

    @keyframes scanline {
        0% { top: 10%; opacity: 0; }
        50% { opacity: 1; }
        100% { top: 90%; opacity: 0; }
    }
</style>

<div class="d-flex flex-column flex-md-row gap-2 align-items-center w-100">
    <form action="{{ url_for('search_products') }}" method="get" class="flex-grow-1 w-100" id="searchForm">
        <div class="input-group">
            <span class="input-group-text bg-white text-muted border-end-0"><i class="bi bi-search"></i></span>
            <input type="search" id="search-input" name="query" class="form-control border-start-0 ps-0 border-end-0" placeholder="Buscar producto..." required>
            <button class="btn btn-outline-secondary border-start-0 border-end-0" type="button" onclick="openScanner()"><i class="bi bi-upc-scan"></i></button>
            <button class="btn btn-success" type="submit">Buscar</button>
        </div>
    </form>
    {% if request.url.path != '/' %}
    <a href="/" class="btn btn-outline-secondary text-nowrap"><i class="bi bi-house-door-fill"></i> Inicio</a>
    {% endif %}
</div>

<div class="modal fade" id="scannerModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">Escanear Código</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" onclick="stopScanner()"></button>
      </div>
      <div class="modal-body p-0 bg-dark text-center">
        
        <div id="interactive" class="viewport">
            <div class="scanner-box">
                <div class="scanner-line"></div>
            </div>
        </div>

        <div class="p-2 text-white bg-dark">
            <small>Centra el código en el recuadro</small>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
    function openScanner() {
        const myModal = new bootstrap.Modal(document.getElementById('scannerModal'));
        myModal.show();
        
        const modalElement = document.getElementById('scannerModal');
        modalElement.addEventListener('shown.bs.modal', startQuagga);
        modalElement.addEventListener('hidden.bs.modal', stopScanner);
    }

    // Algoritmo para verificar si el código EAN-13 es matemáticamente válido
    // Esto evita lecturas parciales (ej: lee 12 digitos en vez de 13)
    function isValidEan13(code) {
        if (!code || code.length !== 13) return false;
        
        let sum = 0;
        for (let i = 0; i < 12; i++) {
            sum += parseInt(code[i]) * (i % 2 === 0 ? 1 : 3);
        }
        
        const checkDigit = (10 - (sum % 10)) % 10;
        return checkDigit === parseInt(code[12]);
    }

    function startQuagga() {
        Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: document.querySelector('#interactive'),
                constraints: {
                    facingMode: "environment",
                    // Pedimos HD para ayudar al enfoque, pero Quagga es flexible
                    width: { min: 640, ideal: 1280, max: 1920 },
                    height: { min: 480, ideal: 720, max: 1080 },
                },
                // RECORTE DE ÁREA: Solo analizamos el centro (donde está el cuadro rojo)
                area: { 
                   top: "30%",    // Ignora el 30% superior
                   right: "10%",  // Ignora el 10% derecho
                   bottom: "30%", // Ignora el 30% inferior
                   left: "10%"    // Ignora el 10% izquierdo
                }
            },
            locator: {
                patchSize: "medium", // 'medium' o 'large' va mejor para códigos de barras que 'x-small'
                halfSample: true     // Procesa menos píxeles para ir más rápido
            },
            numOfWorkers: 2, // Usa 2 hilos del procesador
            frequency: 10,   // Escanea 10 veces por segundo (ahorra batería y CPU)
            decoder: {
                readers: ["ean_reader"] // SOLO EAN-13 (Mercadona)
            },
            locate: true
        }, function(err) {
            if (err) {
                console.log(err);
                alert("Error cámara: " + err);
                return;
            }
            Quagga.start();
            applyFocusFix(); // Intentar forzar enfoque después de iniciar
        });

        // TRUCO PARA IOS/ANDROID: Aplicar enfoque una vez el video está corriendo
        function applyFocusFix() {
            const track = Quagga.CameraAccess.getActiveTrack();
            if (track && typeof track.getCapabilities === 'function') {
                const capabilities = track.getCapabilities();
                // Si soporta enfoque, lo forzamos a continuo
                if (capabilities.focusMode && capabilities.focusMode.includes('continuous')) {
                    track.applyConstraints({ advanced: [{ focusMode: 'continuous' }] });
                }
            }
        }

        // Solo dibujamos cajas si la detección es muy segura
        Quagga.onProcessed(function(result) {
            var drawingCtx = Quagga.canvas.ctx.overlay,
                drawingCanvas = Quagga.canvas.dom.overlay;

            if (result) {
                drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.getAttribute("width")), parseInt(drawingCanvas.getAttribute("height")));
                
                // Solo dibujamos si hay una caja detectada con cierta confianza
                if (result.box) {
                    Quagga.ImageDebug.drawPath(result.box, {x: 0, y: 1}, drawingCtx, {color: "green", lineWidth: 2});
                }
            }
        });

        Quagga.onDetected(function(result) {
            var code = result.codeResult.code;
            
            // 1. Verificamos que sea un número
            // 2. IMPORTANTE: Usamos la validación matemática
            if (isValidEan13(code)) {
                
                // Vibración de éxito
                if (navigator.vibrate) navigator.vibrate(200);
                
                console.log("Código VÁLIDO detectado:", code);
                stopScanner();
                
                const modalEl = document.getElementById('scannerModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();

                document.getElementById('search-input').value = code;
                document.getElementById('searchForm').submit();
            } else {
                console.log("Lectura parcial o inválida ignorada:", code);
                // No hacemos nada, Quagga sigue buscando hasta encontrar uno bueno
            }
        });
    }

    function stopScanner() {
        Quagga.stop();
        const container = document.querySelector('#interactive');
        if(container) container.innerHTML = '<div class="scanner-box"><div class="scanner-line"></div></div>'; 
    }
</script>